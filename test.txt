--main.ts--
import { Plugin} from "obsidian";
import { GalleryModal } from "./galleryModal";
import { renderGalleryFromJson } from "./render";
import { GallerySettingTab } from "./settings";
import { GalleryPluginSettings, DEFAULT_SETTINGS } from "./types";

// ä½¿ç”¨å‘½åå¯¼å‡ºè€Œä¸æ˜¯é»˜è®¤å¯¼å‡º
export default class GalleryJsonPlugin extends Plugin {
  settings: GalleryPluginSettings;

  async onload() {
    console.log("Loading Gallery JSON plugin");
    await this.loadSettings();
    
    // æ³¨å†Œå‘½ä»¤ï¼ˆåœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å¤„ç†ï¼‰
    this.addCommand({
      id: "create-gallery-from-json",
      name: "Create Gallery from JSON File",
      callback: async () => {
        new GalleryModal(this.app, this).open();
      }
    });
    
    // æ³¨å†Œä»£ç å—å¤„ç†å™¨
    this.registerMarkdownCodeBlockProcessor(
      "gallery-json", 
      async (source, el, ctx) => {
        renderGalleryFromJson(source, el, ctx, this.settings,this.app);
      }
    );
    
    // æ³¨å†Œè®¾ç½®é€‰é¡¹å¡
    this.addSettingTab(new GallerySettingTab(this.app, this));
    
    // æ·»åŠ åŠŸèƒ½åŒºå›¾æ ‡
    this.addRibbonIcon("layout-grid", "Create Gallery from JSON", () => {
      new GalleryModal(this.app, this).open();
    });
  }

  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    console.log("Settings loaded:", this.settings);
  }

  async saveSettings() {
    await this.saveData(this.settings);
    console.log("Settings saved");
  }
}
--galleryAttri.ts--

import { App, Modal, TFile, Notice, SuggestModal } from "obsidian";
import  GalleryJsonPlugin  from "./main";
import { DEFAULT_SAMPLE_DATA,GalleryItem } from "./types";

export class GalleryItemForm extends Modal {
  onSubmit: (item: GalleryItem) => void;
  initialItem: GalleryItem;
  
  constructor(
    app: App,
    onSubmit: (item: GalleryItem) => void,
    initialItem?: GalleryItem,
    
  ) {
    super(app);
    this.onSubmit = onSubmit;
    this.initialItem = initialItem || {};
  }
  
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    
    const title = Object.keys(this.initialItem).length ? "Edit Item" : "Add New Item";
    contentEl.createEl("h2", { text: title, cls: "form-title" });
    
    // åˆ›å»ºå±æ€§è¡¨æ ¼å®¹å™¨
    const propertiesTable = contentEl.createDiv({ cls: "properties-container" });
    
    // é¢„å®šä¹‰çš„å±æ€§åˆ—è¡¨ï¼ˆå¸¦å›¾æ ‡ï¼‰
    const predefinedProperties = [
      { key: "Type", icon: "type-icon" },
      { key: "Fields", icon: "fields-icon" },
      { key: "Level", icon: "level-icon" },
      { key: "Source", icon: "source-icon" },
      { key: "Cover", icon: "cover-icon" },
      { key: "Home", icon: "home-icon" },
      { key: "Date", icon: "date-icon" }
    ];
    
    // æ·»åŠ é¢„å®šä¹‰å±æ€§è¡Œ
    predefinedProperties.forEach(prop => {
      this.addPropertyRow(
        propertiesTable,
        prop.key,
        prop.icon,
        this.initialItem[prop.key] || "Empty"
      );
    });
    
    // æ·»åŠ è‡ªå®šä¹‰å±æ€§æŒ‰é’®
    const addPropButton = contentEl.createEl("button", {
      cls: "add-property",
      text: "+ Add a property"
    });
    addPropButton.onclick = () => this.addPropertyRow(propertiesTable);
    
    // æŒ‰é’®å®¹å™¨
    const buttonContainer = contentEl.createDiv({ cls: "button-container" });
    
    // å–æ¶ˆæŒ‰é’®
    const cancelButton = buttonContainer.createEl("button", {
      cls: "cancel-button",
      text: "Cancel"
    });
    cancelButton.onclick = () => this.close();
    
    // ä¿å­˜æŒ‰é’®
    const saveButton = buttonContainer.createEl("button", {
      cls: "save-button",
      text: "Save"
    });
    saveButton.onclick = () => this.saveItem(propertiesTable);
  }
  
  addPropertyRow(
    container: HTMLElement,
    keyPreset: string = "",
    iconClass: string = "",
    valuePreset: string = ""
  ) {
    const row = container.createDiv({ cls: "property-row" });
    
    // å·¦ä¾§å±æ€§å•å…ƒæ ¼
    const propertyCell = row.createDiv({ cls: "property-cell" });
    
    if (iconClass) {
      // æ·»åŠ å±æ€§å›¾æ ‡
      const icon = propertyCell.createSpan({ cls: `property-icon ${iconClass}` });
      icon.setAttr("title", keyPreset);
    }
    
    const keyInput = propertyCell.createEl("input", {
      type: "text",
      placeholder: "Property name",
      value: keyPreset,
      cls: "property-name"
    });
    
    // å³ä¾§å€¼å•å…ƒæ ¼
    const valueCell = row.createDiv({ cls: "value-cell" });
    
    // å¤„ç†æ—¥æœŸç±»å‹çš„ç‰¹æ®Šè¾“å…¥
    if (keyPreset.toLowerCase() === "date") {
      const dateInput = valueCell.createEl("input", {
        type: "date",
        value: valuePreset === "Empty" ? "" : valuePreset,
        cls: "date-picker"
      });
    } else {
      const valueInput = valueCell.createEl("input", {
        type: "text",
        placeholder: "Value",
        value: valuePreset === "Empty" ? "" : valuePreset,
        cls: "property-value"
      });
    }
  }
  
  saveItem(container: HTMLElement) {
    const rows = container.querySelectorAll(".property-row");
    const item: GalleryItem = {};
    let hasData = false;
    
    rows.forEach(row => {
      const keyInput = row.querySelector(".property-name") as HTMLInputElement;
      const valueInput = row.querySelector(".property-value, .date-picker") as HTMLInputElement;
      
      if (keyInput && valueInput) {
        const key = keyInput.value.trim();
        const value = valueInput.value.trim();
        
        if (key && value) {
          item[key] = value;
          hasData = true;
        }
      }
    });
    
    if (hasData) {
      this.onSubmit(item);
      this.close();
      new Notice("Item saved successfully");
    } else {
      new Notice("Please fill at least one property");
    }
  }
  
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
}

--galleryModal.ts--
import { App, Modal, TFile, Notice, SuggestModal } from "obsidian";
import  GalleryJsonPlugin  from "./main";
import { DEFAULT_SAMPLE_DATA,GalleryItem } from "./types";

export class GalleryModal extends Modal {
  plugin: GalleryJsonPlugin;
  
  constructor(app: App, plugin: GalleryJsonPlugin) {
    super(app);
    this.plugin = plugin;
  }
  
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.createEl("h2", { text: "ä»JSONæ–‡ä»¶åˆ›å»ºç”»å»Š" });
    
    // æ–‡ä»¶é€‰æ‹©å™¨
    const fileSelector = contentEl.createDiv({ cls: "gallery-file-selector" });
    fileSelector.createEl("p", { text: "é€‰æ‹©ä¸€ä¸ªJSONæ–‡ä»¶:" });
    
    // æ–‡ä»¶é€‰æ‹©æŒ‰é’®
    const fileButton = fileSelector.createEl("button", { 
      text: "æµè§ˆæ–‡ä»¶",
      cls: "gallery-file-btn"
    });
    
    fileButton.onclick = () => {
      new FileSuggestModal(this.app, async (file) => {
        await this.processJsonFile(file);
        this.close();
      }).open();
    };
    
    // ç¤ºä¾‹æ•°æ®æŒ‰é’®
    const sampleButton = contentEl.createEl("button", {
      text: "ä½¿ç”¨ç¤ºä¾‹æ•°æ®",
      cls: "gallery-sample-btn"
    });
    
    sampleButton.onclick = async () => {
      await this.createGalleryWithSampleData();
      this.close();
    };
  }
  
  async processJsonFile(file: TFile) {
    try {
      const content = await this.app.vault.read(file);
      await this.createGallery(file.basename, content);
      new Notice(`ğŸ¨ ç”»å»Šå·²ä» ${file.name} åˆ›å»º`);
    } catch (error) {
      new Notice(`âš ï¸ åˆ›å»ºç”»å»Šé”™è¯¯: ${error.message}`);
    }
  }
  
  async createGalleryWithSampleData() {
    try {
      await this.createGallery("ç¤ºä¾‹ç”»å»Š", JSON.stringify(DEFAULT_SAMPLE_DATA, null, 2));
      new Notice("ğŸ¨ ä½¿ç”¨ç¤ºä¾‹æ•°æ®åˆ›å»ºç”»å»Š");
    } catch (error) {
      new Notice(`âš ï¸ åˆ›å»ºç¤ºä¾‹ç”»å»Šé”™è¯¯: ${error.message}`);
    }
  }
  
  async createGallery(title: string, jsonContent: string) {
    const newFileName = `${title.replace(/\s+/g, "-")}-${Date.now()}.md`;
    const galleryContent = this.generateGalleryContent(jsonContent);
    
    try {
      const newFile = await this.app.vault.create(newFileName, galleryContent);
      const leaf = this.app.workspace.getLeaf(true);
      await leaf.openFile(newFile);
    } catch (error) {
      throw new Error("æ— æ³•åˆ›å»ºç”»å»Šæ–‡ä»¶ã€‚è¯·æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦æœ‰æ•ˆ");
    }
  }
  
  generateGalleryContent(jsonContent: string): string {
    return `# JSONç”»å»Š\n\n\`\`\`gallery-json\n${jsonContent}\n\`\`\``;
  }
}

class FileSuggestModal extends SuggestModal<TFile> {
  onSelect: (file: TFile) => void;
  
  constructor(app: App, onSelect: (file: TFile) => void) {
    super(app);
    this.onSelect = onSelect;
    this.setPlaceholder("æœç´¢JSONæ–‡ä»¶...");
  }
  
  getSuggestions(query: string): TFile[] {
    return this.app.vault.getFiles().filter(file => 
      file.extension === "json" && 
      file.name.toLowerCase().includes(query.toLowerCase())
    );
  }
  
  renderSuggestion(file: TFile, el: HTMLElement) {
    el.createDiv({ text: file.name, cls: "gallery-suggestion-name" });
    el.createDiv({ text: file.path, cls: "gallery-suggestion-path" });
  }
  
  onChooseSuggestion(file: TFile) {
    this.onSelect(file);
  }
}




--render.ts--
import { App, MarkdownPostProcessorContext, Modal, TFile } from "obsidian";
import { GalleryPluginSettings, GalleryItem, ViewType, SortDirection, SortState } from "./types";
import  {GalleryItemForm}  from "./galleryAttri";
const allowEdit = true;
export function renderGalleryFromJson(
  source: string,
  container: HTMLElement,
  ctx: MarkdownPostProcessorContext,
  settings: GalleryPluginSettings,
  app: App // âœ… ä¼ å…¥ app å®ä¾‹
) {
  container.empty();

  let data: GalleryItem[] = [];

  // 1. è§£æ JSON
  try {
    data = JSON.parse(source);
    if (!Array.isArray(data)) throw new Error("ä¸æ˜¯æ•°ç»„");
  } catch (e) {
    // 2. å¦‚æœä¸ºç©ºæˆ–é”™è¯¯ â†’ æ˜¾ç¤º + å¡ç‰‡
    data = [];
  }

  const state = {
    viewType: settings.defaultView,
    sort: {
      field: settings.defaultSortField,
      direction: settings.defaultSortDirection,
    },
  };

  // 3. æ¸²æŸ“
  renderToolbarAndContent(data, container, state, settings, app);
}

function renderToolbarAndContent(
  data: GalleryItem[],
  container: HTMLElement,
  state: { viewType: ViewType; sort: SortState },
  settings: GalleryPluginSettings,
  app: App
) {
  const toolbar = container.createDiv({ cls: "gallery-toolbar" });
  const contentContainer = container.createDiv({ cls: "gallery-content" });

  const rerender = () => {
    contentContainer.empty();
    if (state.viewType === ViewType.GALLERY) {
      renderGalleryView(data, contentContainer, settings, app);
    } else {
      renderTableView(data, contentContainer, state.sort);
    }
  };

  renderViewSwitcher(toolbar, state, rerender);
  rerender();
}

function renderViewSwitcher(
  toolbar: HTMLElement,
  state: { viewType: ViewType },
  callback: () => void
) {
  const viewGroup = toolbar.createDiv({ cls: "toolbar-group" });

  const galleryBtn = viewGroup.createEl("button", { text: "ç”»å»Šè§†å›¾" });
  const tableBtn = viewGroup.createEl("button", { text: "è¡¨æ ¼è§†å›¾" });

  galleryBtn.onclick = () => {
    state.viewType = ViewType.GALLERY;
    callback();
  };
  tableBtn.onclick = () => {
    state.viewType = ViewType.TABLE;
    callback();
  };
}

function renderGalleryView(
  data: GalleryItem[],
  container: HTMLElement,
  settings: GalleryPluginSettings,
  app: App
) {
  const wrapper = container.createDiv({ cls: "gallery-grid" });

  data.forEach((item,index) => {
    const card = wrapper.createDiv({ cls: "gallery-card" });

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
    card.onclick = (e) => {
      // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
      e.stopPropagation();
      
      // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
      openEditModal(index, data, wrapper, settings, app);
    };


    const imgUrl = item["Avatar"];
    if (imgUrl && typeof imgUrl === "string") {
      const img = card.createEl("img", { attr: { src: imgUrl } });
      img.classList.add("gallery-avatar");
    }

    Object.entries(item).forEach(([key, value]) => {
      if (key === "Avatar") return;
      card.createEl("div", { text: `${key}: ${value}`, cls: "gallery-field" });
    });
    // æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
    const editBtn = card.createEl("button", {
      cls: "edit-button",
      text: "Edit"
    });
    editBtn.onclick = (e) => {
      e.stopPropagation();
      openEditModal(index, data, wrapper, settings, app);
    };


  });

  // âœ… æ·»åŠ  â€œ+ æ·»åŠ é¡¹â€ å¡ç‰‡
  // æ·»åŠ æ–°å»ºå¡ç‰‡
  if (allowEdit) {
    const addCard = wrapper.createDiv({ cls: "gallery-card gallery-add-card" });
    addCard.createDiv({ cls: "add-icon", text: "+" });
    addCard.createDiv({ cls: "add-text", text: "New page" });
    addCard.onclick = () => {
      // è°ƒç”¨ openAddModal å¹¶ä¼ å…¥ app
      openAddModal(data, wrapper, settings, app);
    };
  }
//   const addCard = wrapper.createDiv({ cls: "gallery-add-card" });
//   addCard.innerHTML = `<div class="add-icon">ï¼‹</div><div class="add-text">æ·»åŠ æ–°é¡¹</div>`;
//   addCard.onclick = () => openAddModal(data, wrapper, settings, app);
}

// âœ… æ·»åŠ é¡¹å¼¹çª— Modal
function openAddModal(
  data: GalleryItem[],
  wrapper: HTMLElement,
  settings: GalleryPluginSettings,
  app: App
) {
    // å®šä¹‰æ·»åŠ æ–°é¡¹çš„å›è°ƒå‡½æ•°
  const onAddItem = (newItem: GalleryItem) => {
    data.push(newItem);
    // é‡æ–°æ¸²æŸ“ç”»å»Šè§†å›¾
    renderGalleryView(data, wrapper, settings,app);
    // æ›´æ–°ä»£ç å—å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
    // updateCodeBlock(...);
  };
  new GalleryItemForm(app, onAddItem).open();

}

// âœ… æ·»åŠ ç¼–è¾‘é¡¹å¼¹çª— Modal
function openEditModal(
  index: number,
  data: GalleryItem[],
  wrapper: HTMLElement,
  settings: GalleryPluginSettings,
  app: App
) {
  // å®šä¹‰ç¼–è¾‘é¡¹çš„å›è°ƒå‡½æ•°
  const onEditItem = (editedItem: GalleryItem) => {
    // æ›´æ–°æ•°æ®æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„é¡¹
    data[index] = editedItem;
    
    // é‡æ–°æ¸²æŸ“ç”»å»Šè§†å›¾
    renderGalleryView(data, wrapper, settings, app);
    
    // å¦‚æœéœ€è¦æ›´æ–°ä»£ç å—å†…å®¹
    // updateCodeBlock(source, data, ctx);
    
  };
  
  // åˆ›å»ºå¹¶æ‰“å¼€è¡¨å•æ¨¡æ€æ¡†ï¼Œä¼ å…¥å½“å‰é¡¹ä½œä¸ºåˆå§‹å€¼
  new GalleryItemForm(app, onEditItem, data[index]).open();
}


function renderTableView(data: GalleryItem[], container: HTMLElement, sort: SortState) {
  const table = container.createEl("table", { cls: "gallery-table" });
  const thead = table.createEl("thead");
  const tbody = table.createEl("tbody");

  if (data.length === 0) {
    tbody.createEl("tr").createEl("td", { text: "æ— æ•°æ®" });
    return;
  }

  const keys = Object.keys(data[0]);

  const headRow = thead.createEl("tr");
  keys.forEach(key => {
    headRow.createEl("th", { text: key });
  });

  data.forEach(item => {
    const row = tbody.createEl("tr");
    keys.forEach(key => {
      row.createEl("td", { text: item[key] ?? "" });
    });
  });

  
}

--setttings.ts--
import { App, PluginSettingTab, Setting } from "obsidian";
import  GalleryJsonPlugin  from "./main";
import { GalleryPluginSettings, ViewType, SortDirection } from "./types";

export class GallerySettingTab extends PluginSettingTab {
  plugin: GalleryJsonPlugin;

  constructor(app: App, plugin: GalleryJsonPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  async display(): Promise<void> {
    const { containerEl } = this;
    containerEl.empty();
    containerEl.createEl("h2", { text: "Gallery JSON Settings" });
    
    // é»˜è®¤è§†å›¾è®¾ç½®
    new Setting(containerEl)
      .setName("Default View")
      .setDesc("Initial view when gallery is loaded")
      .addDropdown(dropdown => 
        dropdown
          .addOption(ViewType.GALLERY, "Gallery View")
          .addOption(ViewType.TABLE, "Table View")
          .setValue(this.plugin.settings.defaultView)
          .onChange(async value => {
            this.plugin.settings.defaultView = value as ViewType;
            await this.plugin.saveSettings();
          })
      );
    
    // ç”»å»Šåˆ—æ•°è®¾ç½®
    new Setting(containerEl)
      .setName("Gallery Columns")
      .setDesc("Number of columns in gallery view")
      .addSlider(slider => 
        slider
          .setLimits(1, 5, 1)
          .setValue(this.plugin.settings.galleryColumns)
          .setDynamicTooltip()
          .onChange(async value => {
            this.plugin.settings.galleryColumns = value;
            await this.plugin.saveSettings();
          })
      );
    
    // é»˜è®¤æ’åºå­—æ®µ
    new Setting(containerEl)
      .setName("Default Sort Field")
      .setDesc("Field to sort by default (leave blank for none)")
      .addText(text => 
        text
          .setPlaceholder("e.g., Name")
          .setValue(this.plugin.settings.defaultSortField || "")
          .onChange(async value => {
            this.plugin.settings.defaultSortField = value || null;
            await this.plugin.saveSettings();
          })
      );
    
    // é»˜è®¤æ’åºæ–¹å‘
    new Setting(containerEl)
      .setName("Default Sort Direction")
      .setDesc("Default sort direction")
      .addDropdown(dropdown => 
        dropdown
          .addOption(SortDirection.ASC, "Ascending (A-Z, 0-9)")
          .addOption(SortDirection.DESC, "Descending (Z-A, 9-0)")
          .setValue(this.plugin.settings.defaultSortDirection)
          .onChange(async value => {
            this.plugin.settings.defaultSortDirection = value as SortDirection;
            await this.plugin.saveSettings();
          })
      );
    
    // è‡ªåŠ¨åˆ·æ–°è®¾ç½®
    new Setting(containerEl)
      .setName("Auto Refresh")
      .setDesc("Automatically update galleries when files change")
      .addToggle(toggle => 
        toggle
          .setValue(this.plugin.settings.autoRefresh)
          .onChange(async value => {
            this.plugin.settings.autoRefresh = value;
            await this.plugin.saveSettings();
          })
      );
    
    // ç¼“å­˜å¤–éƒ¨æ–‡ä»¶
    new Setting(containerEl)
      .setName("Cache External Files")
      .setDesc("Cache content of external JSON files for faster loading")
      .addToggle(toggle => 
        toggle
          .setValue(this.plugin.settings.cacheExternalFiles)
          .onChange(async value => {
            this.plugin.settings.cacheExternalFiles = value;
            await this.plugin.saveSettings();
          })
      );
  }
}
--types.ts--
import { Notice } from "obsidian";

// è§†å›¾ç±»å‹
export enum ViewType {
  GALLERY = "gallery",
  TABLE = "table"
}

// æ’åºæ–¹å‘
export enum SortDirection {
  ASC = "asc",
  DESC = "desc"
}

// æ’åºçŠ¶æ€
export interface SortState {
  field: string | null;
  direction: SortDirection;
}

// æ’ä»¶è®¾ç½®
export interface GalleryPluginSettings {
  defaultView: ViewType;
  galleryColumns: number;
  autoRefresh: boolean;
  cacheExternalFiles: boolean;
  defaultSortField: string | null;
  defaultSortDirection: SortDirection;
}

// é»˜è®¤è®¾ç½®
export const DEFAULT_SETTINGS: GalleryPluginSettings = {
  defaultView: ViewType.GALLERY,
  galleryColumns: 3,
  autoRefresh: true,
  cacheExternalFiles: true,
  defaultSortField: null,
  defaultSortDirection: SortDirection.ASC
};

// ç¤ºä¾‹æ•°æ®
export const DEFAULT_SAMPLE_DATA = [
  {
    "Avatar": "https://randomuser.me/api/portraits/women/68.jpg",
    "Name": "Alice",
    "Age": 28,
    "Job": "Engineer"
  },
  {
    "Avatar": "https://randomuser.me/api/portraits/men/45.jpg",
    "Name": "Bob",
    "Age": 35,
    "Job": "Designer"
  }
];

// ä¿®å¤ï¼šæ·»åŠ  GalleryItem ç±»å‹å¯¼å‡º
export type GalleryItem = Record<string, any>;